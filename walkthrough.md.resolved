# PSPManager â€” Fintech Auth System: Walkthrough

## âœ… Verification Results

| Check | Result |
|---|---|
| Backend `npm install` | âœ… Exit 0 |
| Backend `tsc --noEmit` | âœ… Compiles clean (0 errors) |
| Frontend `npm install` | âœ… Exit 0 |
| All files created | âœ… 30+ files across backend + frontend |

---

## ðŸ“ Project Structure

```
c:/Projects/CashLabs_Admin/
â”œâ”€â”€ .env.example                    # Root deployment .env template
â”œâ”€â”€ docker-compose.yml              # 3 services: mongo, api, web
â”‚
â”œâ”€â”€ cashlabs-auth-api/              # Node.js + Express + MongoDB backend
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ config/index.ts         # Centralized config (fails fast on missing env)
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â”œâ”€â”€ User.ts             # password + refreshTokenHash are select:false
â”‚   â”‚   â”‚   â”œâ”€â”€ BlacklistedToken.ts # TTL index = auto self-cleaning blacklist
â”‚   â”‚   â”‚   â””â”€â”€ AuditLog.ts         # Compound index (userId, createdAt)
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â”œâ”€â”€ tokens.ts           # sha256 hash, signAccess/Refresh (separate secrets)
â”‚   â”‚   â”‚   â”œâ”€â”€ asyncHandler.ts     # Prevents unhandled rejections in routes
â”‚   â”‚   â”‚   â””â”€â”€ cookies.ts          # httpOnly + SameSite=Strict + Secure options
â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”‚   â”œâ”€â”€ authenticate.ts     # JWT verify + blacklist check (O(1))
â”‚   â”‚   â”‚   â””â”€â”€ errorHandler.ts     # No stack traces in prod, generic 5xx messages
â”‚   â”‚   â”œâ”€â”€ validators/
â”‚   â”‚   â”‚   â””â”€â”€ auth.schema.ts      # Joi: password strength, hex token format
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ authService.ts      # All security logic (see flows below)
â”‚   â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”‚   â””â”€â”€ AuthController.ts   # Sets cookies, delegates to service
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â””â”€â”€ authRoutes.ts       # asyncHandler wrapped routes
â”‚   â”‚   â”œâ”€â”€ types/express.d.ts      # req.userId type augmentation
â”‚   â”‚   â”œâ”€â”€ app.ts                  # Helmet + CORS + 3-tier rate limit
â”‚   â”‚   â””â”€â”€ server.ts               # DB connection + graceful SIGTERM shutdown
â”‚   â”œâ”€â”€ Dockerfile                  # Multi-stage, non-root user
â”‚   â””â”€â”€ .env.example
â”‚
â””â”€â”€ cashlabs-auth-web/              # Next.js 15 + Tailwind + React Query frontend
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ app/
    â”‚   â”‚   â”œâ”€â”€ auth/
    â”‚   â”‚   â”‚   â”œâ”€â”€ login/page.tsx              # Sign In page
    â”‚   â”‚   â”‚   â”œâ”€â”€ signup/page.tsx             # Create Merchant Account
    â”‚   â”‚   â”‚   â”œâ”€â”€ verify-email/page.tsx       # OTP 6-box verification
    â”‚   â”‚   â”‚   â”œâ”€â”€ forgot-password/page.tsx    # Forgot Password
    â”‚   â”‚   â”‚   â””â”€â”€ registration-success/page.tsx # Success screen
    â”‚   â”‚   â”œâ”€â”€ dashboard/page.tsx              # Protected page with logout
    â”‚   â”‚   â”œâ”€â”€ page.tsx                        # Root â†’ redirect to /auth/login
    â”‚   â”‚   â”œâ”€â”€ layout.tsx                      # ReactQueryProvider + Inter font
    â”‚   â”‚   â””â”€â”€ globals.css                     # Tailwind + auth-input/btn-primary utilities
    â”‚   â”œâ”€â”€ lib/
    â”‚   â”‚   â”œâ”€â”€ axios.ts            # withCredentials + 401â†’refresh interceptor
    â”‚   â”‚   â””â”€â”€ queryClient.tsx     # mutations never retry, 401 queries don't retry
    â”‚   â”œâ”€â”€ features/auth/
    â”‚   â”‚   â”œâ”€â”€ api/authApi.ts      # All typed API calls
    â”‚   â”‚   â”œâ”€â”€ hooks/index.ts      # useAuth/Login/Signup/Logout/Verify hooks
    â”‚   â”‚   â”œâ”€â”€ schemas/index.ts    # Zod: password regex mirrors backend Joi rule
    â”‚   â”‚   â””â”€â”€ types/index.ts      # AuthUser, LoginCredentials, SignupData types
    â”‚   â””â”€â”€ middleware.ts           # Route protection + callbackUrl
    â””â”€â”€ Dockerfile                  # Multi-stage standalone output, non-root user
```

---

## ðŸ” Security Flows Implemented

### Signup
1. Joi validates: password strength (upper+lower+digit+special), email format, terms checkbox
2. Timing-safe: hashes password even if email already exists (prevents enumeration timing attacks)
3. bcrypt cost 12 (~300ms) â€” fintech grade
4. `isVerified=false`, hashed verification token stored with 24h expiry
5. `SIGNUP` event written to AuditLog (fire-and-forget)

### Login
1. Generic "Invalid email or password" message â€” prevents user enumeration
2. Even if user not found, bcrypt.hash is still called (timing-safe)
3. Checks [isLocked()](file:///c:/Projects/CashLabs_Admin/cashlabs-auth-api/src/models/User.ts#93-97) â€” returns exact remaining minutes
4. On wrong password: increments `failedLoginAttempts`, locks after 5 (15 min)
5. On success: resets `failedLoginAttempts`, issues tokens, stores **hashed** refresh token
6. Access token â†’ 15m HTTP-only cookie | Refresh token â†’ 7d HTTP-only cookie
7. Tokens NEVER appear in response body

### Refresh (STRICT ROTATION)
```
Incoming refreshToken cookie
   â†“ jwt.verify (separate secret from access token)
   â†“ sha256 hash the incoming token
   â†“ compare with user.refreshTokenHash in DB
   â”œâ”€â”€ MISMATCH â†’ TOKEN REUSE ATTACK DETECTED
   â”‚     â†’ Wipe refreshTokenHash (invalidate all sessions)
   â”‚     â†’ Write TOKEN_REUSE_DETECTED audit log
   â”‚     â†’ Return 401
   â””â”€â”€ MATCH â†’ Issue new access + refresh pair
         â†’ Update refreshTokenHash in DB (atomic)
         â†’ Set new cookies
```

### Logout  
1. sha256 hash the access token â†’ store in [BlacklistedToken](file:///c:/Projects/CashLabs_Admin/cashlabs-auth-api/src/models/BlacklistedToken.ts#3-7) with `expiresAt` = token expiry
2. MongoDB TTL index auto-deletes the record when the token would have expired anyway
3. Remove `refreshTokenHash` from User
4. Clear both cookies with `maxAge: 0`

### Authenticate Middleware
1. Extract `accessToken` from HTTP-only cookie
2. jwt.verify â€” throws on invalid/expired
3. sha256 hash â†’ indexed O(1) BlacklistedToken lookup
4. Attach `userId` to `req.userId`

---

## ðŸš€ How to Run

### Backend (dev)
```bash
# 1. Create .env from template
cp c:/Projects/CashLabs_Admin/cashlabs-auth-api/.env.example \
   c:/Projects/CashLabs_Admin/cashlabs-auth-api/.env

# 2. Fill in .env values (at minimum MONGO_URI, JWT_ACCESS_SECRET, JWT_REFRESH_SECRET)
# JWT secrets: openssl rand -base64 64

# 3. Start
cd c:/Projects/CashLabs_Admin/cashlabs-auth-api
npm run dev
# â†’ API running at http://localhost:5000
# â†’ Health: http://localhost:5000/health
```

### Frontend (dev)
```bash
# Create .env.local
echo "NEXT_PUBLIC_API_URL=http://localhost:5000" > \
  c:/Projects/CashLabs_Admin/cashlabs-auth-web/.env.local

cd c:/Projects/CashLabs_Admin/cashlabs-auth-web
npm run dev
# â†’ UI at http://localhost:3000
```

### Docker (production)
```bash
cd c:/Projects/CashLabs_Admin
cp .env.example .env
# Fill in .env with production secrets

docker-compose up -d --build
# â†’ MongoDB (internal only)
# â†’ API at :5000
# â†’ Web at :3000
```

---

## ðŸ”’ Security Checklist

| Item | Status |
|------|--------|
| HTTP-only cookies (no JS access) | âœ… |
| SameSite=Strict (CSRF protection) | âœ… |
| Secure flag in production | âœ… |
| Separate JWT secrets (access vs refresh) | âœ… |
| Tokens hashed before DB storage | âœ… |
| Blacklist with TTL auto-expire | âœ… |
| Refresh token rotation (strict) | âœ… |
| Token reuse detection + session wipe | âœ… |
| Account lockout (5 attempts, 15 min) | âœ… |
| bcrypt cost 12 | âœ… |
| Timing-safe user enumeration prevention | âœ… |
| Generic 5xx messages in production | âœ… |
| Stack trace stripped in production | âœ… |
| Helmet (security headers + HSTS) | âœ… |
| CORS restricted to frontend origin | âœ… |
| 3-tier rate limiting (API/Auth/Login) | âœ… |
| Body size limit (10kb) | âœ… |
| Trust proxy for DigitalOcean | âœ… |
| Docker non-root user | âœ… |
| Graceful SIGTERM shutdown | âœ… |
| Audit logging (all auth events) | âœ… |
| IP + User-Agent logging | âœ… |

---

## ðŸ“± UI Pages (Pixel-Perfect Replicas)

| Route | Description | Screenshot Match |
|-------|-------------|-----------------|
| `/auth/login` | PSPManager Sign In | sign_in_to_pspmanager |
| `/auth/signup` | Create Merchant Account | create_your_merchant_account |
| `/auth/verify-email` | OTP 6-box verification | email_verification_otp_screen |
| `/auth/forgot-password` | Request reset link | forgot_password_step_1 |
| `/auth/registration-success` | Account created | registration_success_confirmation |
| `/dashboard` | Protected dashboard with logout | â€” |

---

## âš¡ DigitalOcean Deployment Notes

1. **NGINX config** â€” Add `proxy_set_header X-Forwarded-For $remote_addr;` and set `app.set('trust proxy', 1)` (already done)
2. **Certbot** â€” Get TLS cert for your domain. Cookies require HTTPS for `Secure` flag
3. **COOKIE_DOMAIN** â€” Set to your root domain (e.g., `pspmanager.com`)
4. **FRONTEND_URL** â€” Set to `https://pspmanager.com` for CORS
5. **MongoDB** â€” Use MongoDB Atlas or dedicated Mongo droplet with auth enabled
6. **Secrets** â€” Never use the example secrets. Generate with `openssl rand -base64 64`
